# LOOP 节点使用说明

LOOP 节点用于实现循环执行逻辑，允许在工作流中重复执行一组操作直到满足特定条件。它支持多种循环模式，适用于批量处理、迭代操作和集合遍历等场景。

## 基本功能

- 创建各种类型的循环结构
- 支持WHILE, FOR和FOR_EACH三种循环模式
- 包含子流程区域，可以放置和连接多个子节点
- 控制迭代次数，防止无限循环
- 收集循环处理结果

## 配置说明

### 基本属性

- **循环模式**: 选择循环的类型
  - **WHILE循环**: 当条件为真时持续执行
  - **FOR循环**: 使用初始化、条件和增量表达式
  - **FOR_EACH遍历**: 遍历集合中的每个元素

#### WHILE循环配置

- **条件变量名**: 在条件表达式中使用的变量名
  - 默认: `index`

- **循环条件**: 控制循环执行的条件表达式
  - 例如: `#{index < 10}`
  - 当表达式计算结果为true时继续循环

- **最大迭代次数**: 循环执行的最大次数限制
  - 防止无限循环
  - 范围: 1-100000
  - 默认: 10000

#### FOR_EACH循环配置

- **集合表达式**: 要遍历的集合
  - 例如: `#{payload.items}`
  - 可以是数组或键值对对象

- **元素变量名**: 当前元素的变量名
  - 默认: `item`
  - 在子流程中使用此变量名访问当前元素

- **索引变量名**: 当前索引的变量名
  - 默认: `index`
  - 表示当前遍历的位置(从0开始)

- **最大迭代次数**: 最大遍历元素数量
  - 即使集合更大，也会在达到此限制后停止
  - 默认: 10000

#### FOR循环配置

- **迭代变量名**: 用于循环控制的变量名
  - 默认: `index`

- **初始化表达式**: 设置循环变量初始值
  - 例如: `#{index = 0}`
  - 循环开始前执行一次

- **条件表达式**: 控制循环继续的条件
  - 例如: `#{index < 10}`
  - 每次迭代前检查

- **增量表达式**: 迭代后如何更新变量
  - 例如: `#{index++}` 或 `#{index += 2}`
  - 每次迭代后执行

- **最大迭代次数**: 防止无限循环的安全限制
  - 默认: 10000

### 输出配置

- **输出模式**: 如何处理循环结果
  - **收集所有结果**: 保存每次迭代的结果到数组中
  - **仅最后结果**: 只保留最后一次迭代的结果
  - **不输出**: 不保存任何结果

- **输出变量名**: 存储结果的变量名
  - 默认: `loopResult`
  - 在后续节点中可以通过此变量访问结果

- **结果合并策略**:
  - **数组列表**: 将结果作为数组元素
  - **对象合并**: 尝试将结果合并为一个对象

### 异常处理

- **错误处理策略**:
  - **终止流程**: 出错时停止整个流程
  - **继续执行**: 忽略当前迭代错误，继续下一次迭代
  - **重试执行**: 失败时尝试重新执行当前迭代

- **超时时间(毫秒)**: 整个循环操作的最长等待时间
- **最大重试次数**: 选择重试策略时使用
- **重试间隔(毫秒)**: 两次重试之间的等待时间
- **启用指数退避**: 每次重试等待时间增加
- **失败返回值**: 循环失败时返回的默认JSON数据

## 子流程设计

### 创建子流程

1. 拖放节点到循环节点的子流程区域中
2. 通过连线连接子流程中的节点
3. 从循环入口点(左上角带箭头的蓝色方块)连接到第一个子节点
4. 子流程的最后一个节点通常不需要输出连接

### 子流程区域管理

- 调整循环节点右下角手柄可改变子流程区域大小
- 子节点会自动限制在子流程区域内
- 可以使用鼠标拖动子节点调整位置

## 最佳实践

1. **合理划分循环边界**
   - 将相关操作放在同一循环内
   - 避免在循环中放置过多复杂节点

2. **选择适合的循环模式**
   - 处理集合数据时优先使用FOR_EACH
   - 需要复杂控制逻辑时使用WHILE或FOR
   - 简单的N次重复使用FOR循环

3. **避免无限循环**
   - 确保循环条件最终会变为false
   - 设置合理的最大迭代次数
   - 使用调试功能验证循环终止条件

4. **优化循环性能**
   - 将不需要重复计算的操作放在循环外
   - 考虑批量处理而不是单条处理
   - 使用变量存储中间结果避免重复计算

5. **循环结果处理**
   - 选择合适的输出模式和合并策略
   - 大量数据时考虑不输出或只保留最后结果
   - 使用脚本节点对循环结果进行聚合或转换

## 注意事项

- 循环节点可能导致工作流执行时间大幅增加，特别是嵌套循环
- 集合过大时可能消耗大量内存，特别是使用"收集所有结果"选项时
- 子流程中的变量作用域仅限于当前循环迭代
- 循环节点在任何迭代中遇到错误都会按照错误处理策略处理
- 子流程的复杂度会影响工作流的可读性，过于复杂的子流程考虑拆分
- 使用WHILE模式时，确保循环条件的变量会在子流程中更新，否则可能陷入无限循环
- 调整循环节点大小时注意不要遮挡子节点或连线