# SET_VARIABLE 节点使用说明

SET_VARIABLE 节点用于在工作流中定义和设置变量，使数据能够在不同节点间传递和共享。它是管理工作流数据状态的重要工具。

## 基本功能

- 创建和更新工作流变量
- 支持基本数据类型和复杂对象
- 使用表达式引用和转换数据
- 控制变量的作用域范围
- 集中管理工作流状态

## 配置说明

### 基本属性

- **节点描述**: 为此变量赋值节点添加说明，便于理解其用途

- **变量定义**: 定义要设置的变量，采用键值对形式
  - **键**: 变量名称，应使用符合命名规范的标识符
  - **值**: 变量值，可以是静态值或表达式
  - 支持使用`#{表达式}`语法引用现有变量或执行计算

- **变量作用域**:
  - **流程作用域**: 变量在整个流程中可见，任何后续节点都能访问
  - **局部作用域**: 变量仅在当前分支或子流程中可见，适合临时变量

### 异常处理

- **错误处理策略**:
  - **终止流程**: 出错时停止整个流程
  - **忽略错误**: 出错时继续，使用默认返回值

- **超时时间(毫秒)**: 变量设置操作的最长等待时间
- **失败返回值**: 变量设置失败时返回的默认JSON数据

## 变量引用语法

变量节点允许使用表达式引用既有变量或创建计算值：

- **简单引用**: `#{varName}`
- **对象属性访问**: `#{user.profile.name}`
- **数组索引**: `#{items[0].id}`
- **字符串拼接**: `"Hello, #{user.name}!"`
- **算术运算**: `#{price * quantity}`
- **逻辑运算**: `#{age >= 18 && status == 'active'}`
- **条件表达式**: `#{condition ? trueValue : falseValue}`
- **函数调用**: `#{Math.round(number)}`
- **JSON解析**: `#{JSON.parse(jsonString)}`

## 使用场景示例

### 1. 设置基本变量

定义一组简单变量：
```
userId: 12345
userName: "John Doe"
isActive: true
startDate: "2023-01-01"
```

### 2. 从上游数据提取变量

从HTTP响应中提取数据：
```
user: #{payload.data.user}
token: #{payload.data.authentication.token}
expiry: #{payload.data.authentication.expiresAt}
```

### 3. 计算派生值

基于输入数据计算新值：
```
subtotal: #{items.reduce((sum, item) => sum + item.price * item.quantity, 0)}
tax: #{subtotal * 0.1}
total: #{subtotal + tax}
```

### 4. 格式化数据

转换数据格式：
```
formattedDate: #{new Date(timestamp).toLocaleDateString()}
displayName: #{user.firstName + ' ' + user.lastName}
maskedCard: #{cardNumber.slice(0, 4) + '********' + cardNumber.slice(-4)}
```

## 最佳实践

1. **使用清晰的变量命名**
   - 采用驼峰命名法(`userName`)或下划线命名法(`user_name`)
   - 名称应表达变量的用途和含义
   - 避免过于简单或模糊的名称如`x`, `temp`, `data`

2. **组织相关变量**
   - 使用对象组织相关变量而不是多个独立变量
   - 例如使用`user: { id: 123, name: "John" }`而不是`userId: 123, userName: "John"`

3. **控制变量数量**
   - 避免创建过多变量导致状态难以管理
   - 只保存必要的数据作为变量
   - 考虑使用多个变量节点在不同阶段设置变量

4. **明智地选择变量作用域**
   - 临时变量使用局部作用域减少命名冲突
   - 重要的业务数据使用流程作用域确保可用性

5. **使用变量处理条件逻辑**
   - 计算并存储复杂条件结果，简化后续分支节点
   - 例如: `isEligible: #{age >= 21 && status === 'verified' && !blacklisted}`

6. **文档化变量用途**
   - 使用节点描述说明变量的用途和含义
   - 对复杂表达式添加注释

## 注意事项

- 变量名区分大小写，`userId`和`UserId`是不同的变量
- 变量表达式中的语法错误会导致设置失败
- 过大的变量值(如大型数组)可能影响系统性能
- 循环引用可能导致不可预期的行为(A引用B，B又引用A)
- 局部作用域变量在子流程外不可访问，需要小心规划变量提升
- 表达式是在变量设置时计算的，而不是动态引用，后续变量变化不会影响已设置的值
- 敏感信息不应直接存储在变量中，考虑加密或仅存储非敏感部分
- 相同名称的变量设置会覆盖之前的值，确保不会意外覆盖重要数据